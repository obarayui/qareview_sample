# activity002 - 注文処理システム

## 機能要求
1. **新規注文開始機能**: 顧客が新しい注文を開始できる
2. **品目追加機能**: 顧客が注文に品目を追加できる（複数回可能）
3. **決済機能**: 顧客が注文に対して決済を実行できる
4. **信用審査機能**: 信販会社が利用限度額に基づいて審査を行う（利用限度額以上/未満の判定）
5. **請求拒否機能**: 利用限度額以上の場合、信販会社が請求を拒否する
6. **請求承認機能**: 利用限度額未満の場合、信販会社が請求を承認する
7. **集荷要求機能**: 請求承認後、出荷係員が集荷を要求する
8. **注文梱包機能**: 出荷係員が注文を梱包する
9. **追跡番号割り当て機能**: 配達員が注文に追跡番号を割り当てる
10. **注文集荷機能**: 配達員が注文を集荷する
11. **注文配達機能**: 配達員が注文を配達する

## 非機能要求
1. **柔軟性**: 顧客が必要な数だけ品目を追加できる反復処理
2. **信用管理**: 利用限度額による与信管理で財務リスクを軽減
3. **トレーサビリティ**: 追跡番号により配送状況を追跡可能
4. **役割分担**: 各アクター（顧客、信販会社、出荷係員、配達員）の責任範囲が明確

## 依存関係
1. **「注文に品目を追加する」は「新規の注文を開始する」に依存**: 注文が開始されていないと品目を追加できない
2. **「決済をすませる」は品目追加の完了に依存**: 品目が追加されていないと決済できない
3. **信用審査（利用限度額判定）は「決済をすませる」に依存**: 決済処理後に審査が実行される
4. **「請求を拒否する」または「請求を承認する」は信用審査の結果に依存**: 審査結果により分岐
5. **「集荷を要求する」は「請求を承認する」に依存**: 承認されない限り集荷は行われない
6. **「注文を梱包する」と「追跡番号を割り当てる」は「集荷を要求する」に依存**: 集荷要求後に並行して実行
7. **「注文を集荷する」は「注文を梱包する」と「追跡番号を割り当てる」の両方に依存**: 両方が完了しないと集荷できない
8. **「注文を配達する」は「注文を集荷する」に依存**: 集荷されていない注文は配達できない

## 前提条件・制約
1. **品目追加の反復**: 顧客は追加したい品目がある限り何度でも品目を追加できる
2. **信用限度額による制約**: 利用限度額を超える注文は承認されない
3. **分岐処理**: 利用限度額の判定により「拒否」または「承認」のいずれか一方のフローに進む
4. **並行処理**: 「注文を梱包する」と「追跡番号を割り当てる」は並行して実行可能
5. **同期ポイント**: 梱包と追跡番号割り当ての両方が完了するまで集荷は開始されない
6. **請求拒否時の処理**: 拒否された場合は決済に戻る（再試行可能）

## リスク・例外条件
1. **品目追加の無限ループリスク**: 顧客が品目追加を繰り返し続けた場合の処理（タイムアウト、カート上限など）が不明
2. **決済失敗時の処理**: 決済処理自体が失敗した場合の対応が示されていない
3. **請求拒否後の代替手段**: 拒否された場合に決済方法を変更する選択肢があるかが不明
4. **梱包または追跡番号割り当ての失敗**: 並行処理のいずれかが失敗した場合の処理が不明
5. **配送中の問題**: 集荷後から配達までの間のトラブル（紛失、破損など）への対応が示されていない
6. **信販会社との通信障害**: 信用審査時に信販会社と通信できない場合の処理が不明

## その他の開発上の重要な判断材料
1. **複数アクター間の連携**: 4つの異なるアクター間で情報共有とタイミング調整が必要
2. **外部システム連携**: 信販会社との与信審査システム連携が必要
3. **状態管理**: 注文の状態（品目追加中、決済待ち、審査中、梱包中、配送中など）を管理する必要がある
4. **通知機能**: 各ステップの完了を関係者に通知する機能が必要（例：承認通知、配送通知など）
5. **ロールバック処理**: 請求拒否時に決済に戻るためのロールバック機能が必要
6. **追跡情報の共有**: 追跡番号を顧客や出荷係員と共有する仕組みが必要
